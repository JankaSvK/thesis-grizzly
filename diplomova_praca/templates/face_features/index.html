{% extends 'base.html' %}
{% load static %}
{#{% load staticfiles %}#}


{% block styles %}
    <link rel="stylesheet" href="{% static 'face_features/styles.css' %}">
{% endblock %}

{% block content %}
    <div id="query_zone">
        <i class="arrow right"></i> <i class="arrow left"></i> <i class="arrow up"></i> <i class="arrow down"></i>

        <div id="image_table">

        </div>
    </div>

    <script>
        $(document).ready(function () {
            sendRequest();
        });

        function som_image(src, crop, link) {
            var img_width = 320;
            var img_height = 180;
            var fixed_height = 80;
            var crop_height = img_height * crop['height'];
            var crop_width = img_width * crop['width'];
            var crop_x = crop['x'] * img_width;
            var crop_y = crop['y'] * img_height;

            var ratio = fixed_height / crop_height;

            // TODO: Rewrite as DOM jQuery object
            return `<div    class="column"
                            style="width:${crop_width * ratio}px; height:${crop_height * ratio}px; overflow:hidden;">
                        <a href="javascript:sendRequest('${link}')"><img src=${src}
                                style="width:${img_width * ratio}px; height:${img_height * ratio}px; object-position: ${-crop_x * ratio}px ${-crop_y * ratio}px; object-fit:cover;"
                        /></a>
                    </div>`;
            {# template using inset to crop faces #}
            {# <img src=${src} style="clip-path: inset(${crop['inset']})"/> #}
        }

        function row_divider() {
            return `<div class="clear"></div>`
        }

        function sendRequest(image_src) {
            $.ajax({
                type: "POST",
                dataType: 'json',
                url: "{% url 'select_face_post' %}",
                data: {
                    "json_data": JSON.stringify({
                        "image_src": image_src
                    })
                },
                success(response) {
                    let som_table_content = [];
                    for (const row of response['table']) {
                        som_table_content.push(`<div class="row">`);
                        for (const face of row) {
                            som_table_content.push(som_image(face['img_src'], face['crop'], face['link']));
                        }
                        som_table_content.push(`</div>`);
                        som_table_content.push(row_divider());
                    }

                    $("#image_table").html(som_table_content.join(""));
                },
                failure(data) {
                    console.log("Failure", data);
                }
            });
        }



    </script>
{% endblock %}
{% extends 'base.html' %}
{% load static %}
{#{% load staticfiles %}#}


{% block styles %}
    <link rel="stylesheet" href="{% static 'face_features/styles.css' %}">
{% endblock %}

{% block content %}

    <div id="query_zone">
        <a href="javascript:sendRequest('right')"><i class="arrow right"></i></a>
        <a href="javascript:sendRequest('left')"><i class="arrow left"></i></a>
        <a href="javascript:sendRequest('up')"><i class="arrow up"></i></a>
        <a href="javascript:sendRequest('down')"><i class="arrow down"></i></a>
        <a href="javascript:sendRequest('out')">OUT</a>

        <div id="image_table">

        </div>

        <span id="view_info"></span>

    </div>

    <script>
        let display = {
            width: 0,
            height: 0,
            count: 0
        };
        var view = null;

        $(document).ready(function () {
            sendRequest(null);
        });


        function som_image(src, crop, link) {
            var img_width = 320;
            var img_height = 180;
            var fixed_height = 80;
            var crop_height = img_height * crop['height'];
            var crop_width = img_width * crop['width'];
            var crop_x = crop['x'] * img_width;
            var crop_y = crop['y'] * img_height;

            var ratio = fixed_height / crop_height;

            // TODO: Rewrite as DOM jQuery object
            return `<div    class="column"
                            style="width:${crop_width * ratio}px; height:${crop_height * ratio}px; overflow:hidden;">
                        <a href="javascript:sendRequest('in', '${link}')"><img src=${src}
                                style="width:${img_width * ratio}px; height:${img_height * ratio}px; object-position: ${-crop_x * ratio}px ${-crop_y * ratio}px; object-fit:cover;"
                        /></a>
                    </div>`;
            {# template using inset to crop faces #}
            {# <img src=${src} style="clip-path: inset(${crop['inset']})"/> #}
        }

        function row_divider() {
            return `<div class="clear"></div>`
        }

        function sendRequest(action, link = null) {
            $.ajax({
                type: "POST",
                dataType: 'json',
                {#url: "{% url 'select_face_post' %}",#}
                url: "{% url 'repr_tree_post' %}",
                data: {
                    "json_data": JSON.stringify({
                        "layer": {
                            "index" : null,
                            "center" : null
                        },
                        "action": action,
                        "view": view,
                        "selected": link,
                        "display_size": {
                            "width": display.width,
                            "height": display.height,
                            "count": display.count
                        }
                    })
                },
                success(response) {
                    view = response['view'];
                    let som_table_content = [];
                    for (const row of response['table']) {
                        som_table_content.push(`<div class="row">`);
                        for (const face of row) {
                            som_table_content.push(som_image(face['img_src'], face['crop'], `${face['i_row']},${face['i_column']}`));
                        }
                        som_table_content.push(`</div>`);
                        som_table_content.push(row_divider());
                    }

                    $("#image_table").html(som_table_content.join(""));
                    console.log(view);
                    $("#view_info").html(JSON.stringify(view, null, 4));
                    display.width = response['view_width'];
                    display.height = response['view_height'];
                    display.count = resposne['view_count'];
                },
                failure(data) {
                    console.log("Failure", data);
                }
            });
        }



    </script>
{% endblock %}